#!/bin/bash

EXPECTED_ARGS=2
E_BADARGS=65

if [ $# -ne $EXPECTED_ARGS ]
then
  echo "Usage: `basename $0` node_number number_of_nodes"
  echo "node_number: 0 - admin node, 1, 2, ... server nodes"
  echo "number_of_nodes: number of all server nodes in the ceph cluster"
  exit $E_BADARGS
fi




NETWORK_GATEWAY=10.0.2.2
NETWORK_IP_PREFIX=10.0.1.   # network address for ceph internal network
NETWORK_START_IP=10         # first IP adress - 10.0.1.10 ... 
NETWORK_INTERFACE=eth2      # interface for ceph internal network
NODE_NUMBER=$1              # 0=admin, 1..=server nodes
NODE_COUNT=$2               # number of server nodes



NODE_NUMBER=0
NODE_COUNT=1


####
NETWORK_IP=${NETWORK_IP_PREFIX}$(($NETWORK_START_IP + $NODE_NUMBER))
HOSTNAME=ceph_node_${NODE_NUMBER}
[ ${NODE_NUMBER} == "0" ] && HOSTNAME=ceph_admin
####



mkdir -p ~/.ssh

function add_node_entry {
  if ! grep -q ceph_admin /etc/hosts; then
    echo "$1 $2" >> /etc/hosts
  fi
  if ! grep -q ceph_admin ~/.ssh/config; then
    echo "Host $2
        Hostname ceph_admin
        User ceph" >> ~/.ssh/config
  fi
}


# generate hosts and ssh config file entries for ceph_admin and ceph_node_X 
add_node_entry "${NETWORK_IP_PREFIX}${NETWORK_START_IP}" "ceph_admin"
for (( CURRENT_NODE=1; CURRENT_NODE<=$NODE_COUNT; CURRENT_NODE++ )); do
  add_node_entry "${NETWORK_IP_PREFIX}$(($NETWORK_START_IP + $CURRENT_NODE))" "ceph_node_${CURRENT_NODE}" 
done



#set up internal network

sed -i "s/HOSTNAME=.*/HOSTNAME=${HOSTNAME}/g" /etc/sysconfig/network

echo "DEVICE=${NETWORK_INTERFACE} 
BOOTPROTO=none 
NM_CONTROLLED="no"
ONBOOT=yes 
NAME='Ceph internal network'
NETWORK=${NETWORK_IP_PREFIX}0
NETMASK=255.255.255.0 
IPADDR=${NETWORK_IP}
GATEWAY=${NETWORK_GATEWAY}
USERCTL=no" > /etc/sysconfig/network-scripts/ifcfg-${NETWORK_INTERFACE}

#chkconfig network on
/etc/init.d/network restart





sudo useradd -d /home/ceph -m ceph

#sudo passwd ceph

echo "ceph ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ceph
sudo chmod 0440 /etc/sudoers.d/ceph




sudo -u ceph -H mkdir -p /home/ceph/.ssh
sudo -u ceph -H ssh-keygen -f /home/ceph/.ssh/ceph_rsa -t rsa -N ''





for f in keys/*.key; do 
  sudo rpm --import $f
done


# for basic ceph-deploy
rpm -Uvh rpm/ceph-deploy-1.2.7-0.noarch.rpm rpm/pushy-0.5.3-1.noarch.rpm rpm/python-argparse-1.2.1-2.el6.noarch.rpm rpm/python-setuptools-0.6.10-3.el6.noarch.rpm


#sudo yum install -y snappy leveldb gdisk python-argparse gperftools-libs






