#!/bin/bash

EXPECTED_ARGS=2
E_BADARGS=65

if [ $# -ne $EXPECTED_ARGS ]
then
  echo "Usage: `basename $0` node_number number_of_nodes"
  echo "node_number: 0 - admin node, 1, 2, ... server nodes"
  echo "number_of_nodes: number of all server nodes in the ceph cluster"
  exit $E_BADARGS
fi




NETWORK_GATEWAY=10.0.2.2
NETWORK_IP_PREFIX=10.0.1.   # network address for ceph internal network
NETWORK_START_IP=10         # first IP adress - 10.0.1.10 ... 
NETWORK_INTERFACE=eth2      # interface for ceph internal network
NODE_NUMBER=$1              # 0=admin, 1..=server nodes
NODE_COUNT=$2               # number of server nodes



NODE_NUMBER=0
NODE_COUNT=1


####
NETWORK_IP=${NETWORK_IP_PREFIX}$(($NETWORK_START_IP + $NODE_NUMBER))
HOSTNAME=ceph_node_${NODE_NUMBER}
[ ${NODE_NUMBER} == "0" ] && HOSTNAME=ceph_admin
####


# generate hosts and ssh config file entries for ceph_admin and ceph_node_X 

mkdir -p ~/.ssh

if ! grep -q ceph_admin /etc/hosts; then
  echo "${NETWORK_IP_PREFIX}${NETWORK_START_IP} ceph_admin" >> /etc/hosts
fi
if ! grep -q ceph_admin ~/.ssh/config; then
  echo "Host ceph_admin
        Hostname ceph_admin
        User ceph" >> ~/.ssh/config
fi
for (( CURRENT_NODE=1; CURRENT_NODE<=$NODE_COUNT; CURRENT_NODE++ )); do
  if ! grep -q ceph_node_${CURRENT_NODE} /etc/hosts; then
    echo "${NETWORK_IP_PREFIX}$(($NETWORK_START_IP + $CURRENT_NODE)) ceph_node_${CURRENT_NODE}" >> /etc/hosts
  fi
  if ! grep -q ceph_node_${CURRENT_NODE} ~/.ssh/config; then
    echo "Host ceph_node_${CURRENT_NODE}
        Hostname ceph_node_${CURRENT_NODE}
        User ceph" >> ~/.ssh/config
  fi
done



#set up internal network

sed -i "s/HOSTNAME=.*/HOSTNAME=${HOSTNAME}/g" /etc/sysconfig/network

echo "DEVICE=${NETWORK_INTERFACE} 
BOOTPROTO=none 
NM_CONTROLLED="no"
ONBOOT=yes 
NAME='Ceph internal network'
NETWORK=${NETWORK_IP_PREFIX}0
NETMASK=255.255.255.0 
IPADDR=${NETWORK_IP}
GATEWAY=${NETWORK_GATEWAY}
USERCTL=no" > /etc/sysconfig/network-scripts/ifcfg-${NETWORK_INTERFACE}

#chkconfig network on
/etc/init.d/network restart


sudo useradd -d /home/ceph -m ceph

#sudo passwd ceph

echo "ceph ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/ceph
sudo chmod 0440 /etc/sudoers.d/ceph




sudo -u ceph -H mkdir -p /home/ceph/.ssh
sudo -u ceph -H ssh-keygen -f /home/ceph/.ssh/ceph_rsa -t rsa -N ''






sudo rpm --import 'https://ceph.com/git/?p=ceph.git;a=blob_plain;f=keys/release.asc'


su -c 'rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm'


sudo yum install -y snappy leveldb gdisk python-argparse gperftools-libs


su -c 'rpm -Uvh http://ceph.com/rpm-dumpling/el6/noarch/ceph-release-1-0.el6.noarch.rpm'

sudo yum install -y ceph-deploy python-pushy




sudo yum install -y ceph


rpm -ivh fcgi-2.4.0-10.el6.x86_64.rpm
rpm -ivh mod_fastcgi-2.4.6-2.el6.rf.x86_64.rpm





# sudo yum update -y --downloadonly --downloaddir=/tmp/rpm snappy leveldb gdisk python-argparse gperftools-libs ceph-deploy python-pushy ceph 




